<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø³Ø¨ÙƒÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© v5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #010409; color: #e6edf3; overflow: hidden; }
        .glass { background: rgba(13, 17, 23, 0.98); backdrop-filter: blur(15px); border: 1px solid #30363d; }
        .full-page { position: fixed; inset: 0; z-index: 500; background: #010409; display: none; flex-direction: column; overflow-y: auto; }
        .pdf-viewer-container { flex: 1; height: 80vh; border: 2px solid #30363d; border-radius: 20px; overflow: hidden; margin: 10px; }
        .word-span { cursor: pointer; display: inline-block; padding: 0 2px; transition: 0.2s; border-radius: 4px; }
        .word-span:hover { background: rgba(88, 166, 255, 0.3); color: #58a6ff; }
        .translation-popup { position: absolute; background: #58a6ff; color: white; padding: 8px 15px; border-radius: 12px; font-size: 14px; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-weight: bold; }
        .loader { width: 50px; height: 50px; border: 5px solid #30363d; border-top-color: #58a6ff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .option-btn { background: #21262d; border: 1px solid #30363d; width: 100%; padding: 1.2rem; border-radius: 1.5rem; text-align: right; margin-bottom: 0.8rem; }
        .correct { background: #238636 !important; }
        .wrong { background: #da3633 !important; }
    </style>
</head>
<body>

    <button id="menuBtn" class="fixed top-6 right-6 z-[1100] bg-blue-600 p-3 rounded-2xl hidden shadow-2xl">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
    </button>
    <div id="sidebar" class="fixed inset-y-0 right-0 w-80 glass transform translate-x-full p-8 shadow-2xl z-[1050] transition-transform duration-300">
        <h2 class="text-2xl font-bold mb-10 text-blue-500 italic border-b border-gray-800 pb-4 text-right">Sobky AI</h2>
        <nav class="space-y-6 text-right font-bold">
            <button onclick="checkAdmin()" class="w-full text-right hover:text-blue-400 flex items-center gap-3">ğŸ‘¤ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
            <button onclick="showPage('statsPage')" class="w-full text-right hover:text-blue-400">â± Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</button>
            <button onclick="showPage('historyPage')" class="w-full text-right hover:text-blue-400">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
            <button onclick="showPage('vaultPage')" class="w-full text-right text-green-400">ğŸ“¦ Ø§Ù„Ø®Ø²Ù†Ø©</button>
            <button onclick="location.reload()" class="w-full text-right text-red-500 mt-20">ğŸšª Ø®Ø±ÙˆØ¬</button>
        </nav>
        <div class="absolute bottom-10 left-8 right-8 p-5 bg-blue-900/20 rounded-[2rem] text-center">
            <p class="text-[10px] text-gray-500 mb-2">ÙˆÙ‚Øª Ø§Ù„Ø¬Ù„Ø³Ø©</p>
            <div id="sessionTimer" class="text-3xl font-bold text-blue-400">00:00:00</div>
        </div>
    </div>

    <div id="loginScreen" class="fixed inset-0 z-[1200] flex items-center justify-center bg-[#010409] p-4 text-right">
        <div class="glass p-10 rounded-[3rem] w-full max-w-md border-t-8 border-blue-600 shadow-2xl">
            <h1 class="text-4xl font-bold text-center mb-10 text-blue-500">Sobky AI</h1>
            <div class="space-y-4">
                <input type="text" id="nameInp" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full bg-[#0d1117] border border-[#30363d] p-4 rounded-2xl outline-none focus:border-blue-500">
                <input type="tel" id="phoneInp" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" class="w-full bg-[#0d1117] border border-[#30363d] p-4 rounded-2xl outline-none focus:border-blue-500">
                <input type="password" id="passInp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full bg-[#0d1117] border border-[#30363d] p-4 rounded-2xl outline-none focus:border-blue-500">
                <button onclick="handleLogin()" class="w-full bg-blue-600 py-4 rounded-2xl font-bold text-xl active:scale-95 transition">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
            </div>
        </div>
    </div>

    <div id="mainDashboard" class="p-6 pt-24 max-w-6xl mx-auto hidden text-right">
        <div class="glass p-6 rounded-3xl mb-10 flex justify-between items-center">
            <div>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="userName" class="text-blue-400 font-bold"></span></div>
            <button onclick="document.getElementById('pdfInp').click()" class="bg-blue-600 px-6 py-2 rounded-xl text-sm font-bold shadow-lg">+ Ø±ÙØ¹ Ù…Ù„Ù</button>
            <input type="file" id="pdfInp" class="hidden" accept=".pdf" onchange="handleUpload(event)">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <button onclick="showPage('studyPage')" class="glass p-10 rounded-[2.5rem] flex flex-col items-center gap-4 border-b-8 border-blue-500 active:scale-95 transition">
                <span class="text-5xl">ğŸ“–</span><span class="text-xl font-bold">Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</span>
            </button>
            <button onclick="startExam('normal')" class="glass p-10 rounded-[2.5rem] flex flex-col items-center gap-4 border-b-8 border-orange-500 active:scale-95 transition">
                <span class="text-5xl">ğŸ“</span><span class="text-xl font-bold">Ø§Ù…ØªØ­Ø§Ù† (10Ø³)</span>
            </button>
            <button onclick="startExam('comprehensive')" class="glass p-10 rounded-[2.5rem] flex flex-col items-center gap-4 border-b-8 border-purple-500 active:scale-95 transition">
                <span class="text-5xl">ğŸ†</span><span class="text-xl font-bold">Ø´Ø§Ù…Ù„ (30Ø³)</span>
            </button>
        </div>
    </div>

    <div id="studyPage" class="full-page">
        <div class="flex justify-between items-center p-4 bg-[#0d1117] mb-4">
            <button onclick="hidePage('studyPage')" class="bg-red-500 px-6 py-2 rounded-xl font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
            <span class="text-blue-400 font-bold">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ÙƒÙ„Ù…Ø© Ù„Ù„ØªØ±Ø¬Ù…Ø©</span>
        </div>
        <div id="studyContent" class="glass p-10 rounded-3xl leading-[2.2] text-right text-2xl min-h-screen overflow-y-auto">
            </div>
    </div>

    <div id="examPage" class="full-page flex flex-col items-center justify-center">
        <div class="w-full max-w-2xl glass p-10 rounded-[3rem] relative shadow-2xl">
            <button onclick="hidePage('examPage')" class="absolute top-6 left-6 text-gray-500">Ø®Ø±ÙˆØ¬</button>
            <div id="examBox" class="text-center"></div>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyC1BwXz-nHSiFfxh5ux5Y6RexU0FqlD9do";
        let user = null, pdfs = [], seconds = 0;

        // Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª
        setInterval(() => { if(user) { seconds++; updateTimer(); } }, 1000);
        function updateTimer() {
            const h = Math.floor(seconds/3600).toString().padStart(2,'0');
            const m = Math.floor((seconds%3600)/60).toString().padStart(2,'0');
            const s = (seconds%60).toString().padStart(2,'0');
            document.getElementById('sessionTimer').innerText = `${h}:${m}:${s}`;
        }

        function handleLogin() {
            const n = document.getElementById('nameInp').value, p = document.getElementById('passInp').value;
            if(p === "elsobky12222" && n.length > 2) {
                user = { name: n, phone: document.getElementById('phoneInp').value };
                document.getElementById('userName').innerText = n;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                document.getElementById('menuBtn').style.display = 'block';
            } else alert("Ø®Ø·Ø£!");
        }

        async function handleUpload(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdfJS = await pdfjsLib.getDocument(typedarray).promise;
                let text = "";
                for(let i=1; i<=pdfJS.numPages; i++) {
                    const page = await pdfJS.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(s => s.str).join(" ") + " ";
                }
                pdfs.push({ name: file.name, text: text });
                alert("ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
            };
            reader.readAsArrayBuffer(file);
        }

        function showPage(id) {
            if(pdfs.length === 0 && id !== 'statsPage') return alert("Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹!");
            document.getElementById(id).style.display = 'flex';
            if(id === 'studyPage') {
                const words = pdfs[pdfs.length-1].text.split(/\s+/);
                document.getElementById('studyContent').innerHTML = words.map(w => `<span class="word-span" onclick="translateMe(this)">${w} </span>`).join('');
            }
        }

        function hidePage(id) { document.getElementById(id).style.display = 'none'; }

        async function translateMe(el) {
            const word = el.innerText.trim(); if(word.length < 2) return;
            document.querySelectorAll('.translation-popup').forEach(p => p.remove());
            const popup = document.createElement('div');
            popup.className = 'translation-popup'; popup.innerText = "...";
            el.appendChild(popup);
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: "POST", body: JSON.stringify({ contents: [{ parts: [{ text: `Translate "${word}" to Arabic concise.` }] }] })
                });
                const data = await res.json();
                popup.innerText = data.candidates[0].content.parts[0].text;
            } catch(e) { popup.innerText = "Error"; }
        }

        async function startExam(type) {
            if(pdfs.length === 0) return alert("Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹!");
            showPage('examPage');
            const box = document.getElementById('examBox');
            box.innerHTML = `<div class="loader mx-auto mb-4"></div><p>Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p>`;
            
            const count = type === 'comprehensive' ? 30 : 10;
            const source = type === 'comprehensive' ? pdfs.map(p => p.text).join(" ") : pdfs[pdfs.length-1].text;
            
            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø·Ø£
            const cleanSource = source.substring(0, 4500); 

            const prompt = `Based on: "${cleanSource}", generate ${count} MCQ in Arabic. Format strictly as JSON array: [{"q":"..","o":["..","..","..",".."],"a":index}]`;
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: "POST", body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const jsonText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const questions = JSON.parse(jsonText);
                
                let cur = 0, score = 0;
                const renderQ = () => {
                    const q = questions[cur];
                    box.innerHTML = `
                        <div class="text-right">
                            <span class="bg-blue-600 px-3 py-1 rounded-full text-xs font-bold mb-4 inline-block">Ø³Ø¤Ø§Ù„ ${cur+1}/${count}</span>
                            <h3 class="font-bold text-xl mb-8 leading-relaxed">${q.q}</h3>
                            <div class="space-y-3">${q.o.map((o, i) => `<button onclick="checkAns(${i}, ${q.a}, this)" class="option-btn">${o}</button>`).join('')}</div>
                            <button id="nxtBtn" disabled onclick="nextQ()" class="w-full mt-8 bg-white text-black py-4 rounded-2xl font-bold opacity-20">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>
                        </div>
                    `;
                };
                window.checkAns = (i, a, btn) => {
                    const btns = document.querySelectorAll('.option-btn'); btns.forEach(b => b.disabled = true);
                    if(i === a) { btn.classList.add('correct'); score++; }
                    else { btn.classList.add('wrong'); btns[a].classList.add('correct'); }
                    document.getElementById('nxtBtn').disabled = false; document.getElementById('nxtBtn').style.opacity = "1";
                };
                window.nextQ = () => {
                    cur++; if(cur < count) renderQ();
                    else box.innerHTML = `<h2 class="text-6xl font-bold mb-6">${score}/${count}</h2><button onclick="hidePage('examPage')" class="bg-blue-600 px-10 py-3 rounded-2xl font-bold">Ø±Ø¬ÙˆØ¹</button>`;
                };
                renderQ();
            } catch(e) { box.innerHTML = "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ø¨Ù…Ù„Ù Ø£ØµØºØ± Ø£Ùˆ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª."; }
        }

        document.getElementById('menuBtn').onclick = () => document.getElementById('sidebar').classList.toggle('translate-x-full');
    </script>
</body>
</html>
