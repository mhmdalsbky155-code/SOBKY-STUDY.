<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø³Ø¨ÙƒÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #010409; color: #e6edf3; }
        .glass { background: rgba(13, 17, 23, 0.95); backdrop-filter: blur(20px); border: 1px solid #30363d; }
        .sidebar { transition: transform 0.3s; z-index: 1000; }
        .word-span { cursor: pointer; position: relative; display: inline-block; }
        .word-span:hover { background: rgba(88, 166, 255, 0.2); border-radius: 4px; }
        .translation-popup { position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: #58a6ff; color: white; padding: 5px 12px; border-radius: 8px; font-size: 14px; z-index: 2000; white-space: nowrap; }
        .option-btn { background: #21262d; border: 1px solid #30363d; width: 100%; padding: 0.8rem; border-radius: 1rem; text-align: right; margin-bottom: 0.5rem; transition: 0.3s; }
        .correct { background: #238636 !important; }
        .wrong { background: #da3633 !important; }
        .loader { width: 30px; height: 30px; border: 3px solid #30363d; border-top-color: #58a6ff; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <button id="menuBtn" class="fixed top-5 right-5 z-[1100] bg-blue-600 p-2 rounded-lg hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
    </button>
    <div id="sidebar" class="fixed inset-y-0 right-0 w-72 glass sidebar transform translate-x-full p-6 overflow-y-auto shadow-2xl">
        <h2 class="text-xl font-bold mb-6 text-blue-400 border-b border-gray-700 pb-2">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h2>
        <nav class="space-y-4 text-right text-sm">
            <button onclick="showAdminPrompt()" class="w-full text-right hover:text-blue-400">ğŸ›  Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (1542)</button>
            <button onclick="showSection('studyStats')" class="w-full text-right hover:text-blue-400">â± Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</button>
            <button onclick="showSection('examHistory')" class="w-full text-right hover:text-blue-400">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</button>
            <button onclick="showSection('vault')" class="w-full text-right hover:text-blue-400">ğŸ“¦ Ø§Ù„Ø®Ø²Ù†Ø©</button>
            <button onclick="showSection('mainDashboard')" class="w-full text-right hover:text-blue-400">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button onclick="showSection('support')" class="w-full text-right hover:text-blue-400">ğŸš© Ø¨Ù„Ø§Øº Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­</button>
            <button onclick="location.reload()" class="w-full text-right text-red-500 mt-6">ğŸšª Ø®Ø±ÙˆØ¬</button>
        </nav>
        <div class="mt-10 p-4 bg-blue-900/20 rounded-xl text-center">
            <p class="text-[10px] text-gray-400">Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
            <div id="sessionTimer" class="text-xl font-bold text-blue-400">00:00:00</div>
        </div>
    </div>

    <div id="authScreen" class="fixed inset-0 z-[1200] flex items-center justify-center bg-[#010409] p-4">
        <div class="glass p-8 rounded-[2rem] w-full max-w-md border-t-4 border-blue-600">
            <h1 class="text-3xl font-bold text-center mb-6">Sobky AI</h1>
            <div class="space-y-4">
                <input type="text" id="uName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full bg-[#0d1117] border border-[#30363d] p-3 rounded-xl outline-none focus:border-blue-500">
                <input type="text" id="uID" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ (ID)" class="w-full bg-[#0d1117] border border-[#30363d] p-3 rounded-xl outline-none focus:border-blue-500">
                <input type="tel" id="uPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†" class="w-full bg-[#0d1117] border border-[#30363d] p-3 rounded-xl outline-none focus:border-blue-500">
                <input type="password" id="uPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full bg-[#0d1117] border border-[#30363d] p-3 rounded-xl outline-none focus:border-blue-500">
                <button onclick="login()" class="w-full bg-blue-600 py-3 rounded-xl font-bold">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            </div>
        </div>
    </div>

    <div id="contentArea" class="p-4 pt-20 max-w-7xl mx-auto hidden">
        <section id="mainDashboard" class="section">
            <div class="glass p-6 rounded-2xl mb-6 flex justify-between items-center">
                <div>Ø£Ù‡Ù„Ø§Ù‹ØŒ <span id="userName" class="text-blue-400 font-bold"></span></div>
                <input type="file" id="pdfInp" class="hidden" accept=".pdf" onchange="processPDF(event)">
                <button onclick="document.getElementById('pdfInp').click()" class="bg-blue-600 px-6 py-2 rounded-xl text-sm font-bold">+ Ø±ÙØ¹ PDF</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-[70vh]">
                <div id="pdfView" class="md:col-span-2 glass p-6 rounded-2xl overflow-y-auto leading-loose text-right text-lg"></div>
                <div id="actionSide" class="glass p-6 rounded-2xl overflow-y-auto relative">
                    <div class="flex gap-2 mb-4">
                        <button onclick="startMode('exam')" class="flex-1 bg-orange-600 py-2 rounded-lg text-xs">Ø§Ù…ØªØ­Ø§Ù† (10Ø³)</button>
                        <button onclick="startMode('comprehensive')" class="flex-1 bg-purple-600 py-2 rounded-lg text-xs">Ø´Ø§Ù…Ù„ (30Ø³)</button>
                    </div>
                    <div id="sideContent" class="text-center text-gray-500 mt-10">Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡</div>
                </div>
            </div>
        </section>

        <section id="vault" class="section hidden">
            <h2 class="text-2xl font-bold mb-6">ğŸ“¦ Ø§Ù„Ø®Ø²Ù†Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</h2>
            <div id="vaultList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="studyStats" class="section hidden">
            <h2 class="text-2xl font-bold mb-6 text-blue-400">â± Ø³Ø¬Ù„ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</h2>
            <div class="glass p-6 rounded-2xl overflow-x-auto">
                <table class="w-full text-right text-sm">
                    <thead><tr class="border-b border-gray-700"><th class="p-2">Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-2">Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</th></tr></thead>
                    <tbody id="statsBody"></tbody>
                </table>
            </div>
        </section>

        <section id="examHistory" class="section hidden">
            <h2 class="text-2xl font-bold mb-6 text-orange-400">ğŸ“Š Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
            <div id="historyList" class="space-y-3"></div>
        </section>

        <section id="adminPanel" class="section hidden">
            <h2 class="text-2xl font-bold mb-6 text-red-500 font-bold">ğŸ›  Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø®Ø§Øµ Ø¨Ø§Ù„Ø³Ø¨ÙƒÙŠ)</h2>
            <div id="adminData" class="grid grid-cols-1 lg:grid-cols-3 gap-4"></div>
        </section>

        <section id="support" class="section hidden">
            <div class="glass p-8 rounded-3xl max-w-xl mx-auto">
                <h2 class="text-2xl font-bold mb-4">ğŸš© ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
                <textarea id="msg" class="w-full bg-black/20 border border-gray-700 p-4 rounded-xl mb-4 h-32" placeholder="Ø§ÙƒØªØ¨ Ø´ÙƒÙˆØ§Ùƒ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ùƒ Ù‡Ù†Ø§..."></textarea>
                <div id="stars" class="flex gap-2 mb-6 text-2xl">
                    <span onclick="setRate(1)" class="star cursor-pointer">â˜…</span><span onclick="setRate(2)" class="star cursor-pointer">â˜…</span><span onclick="setRate(3)" class="star cursor-pointer">â˜…</span><span onclick="setRate(4)" class="star cursor-pointer">â˜…</span><span onclick="setRate(5)" class="star cursor-pointer">â˜…</span>
                </div>
                <button onclick="sendMsg()" class="w-full bg-blue-600 py-3 rounded-xl font-bold">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
        </section>
    </div>

    <script>
        const API_KEY = "AIzaSyC1BwXz-nHSiFfxh5ux5Y6RexU0FqlD9do";
        let currentUser = null;
        let allPDFs = [];
        let sessionSeconds = 0;
        let examStartTime = 0;
        let rating = 0;

        // Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª
        setInterval(() => {
            if(currentUser) {
                sessionSeconds++;
                const h = Math.floor(sessionSeconds/3600).toString().padStart(2,'0');
                const m = Math.floor((sessionSeconds%3600)/60).toString().padStart(2,'0');
                const s = (sessionSeconds%60).toString().padStart(2,'0');
                document.getElementById('sessionTimer').innerText = `${h}:${m}:${s}`;
            }
        }, 1000);

        function login() {
            const name = document.getElementById('uName').value;
            const pass = document.getElementById('uPass').value;
            if(pass === "elsobky12222" && name.length > 2) {
                currentUser = { 
                    name, 
                    id: document.getElementById('uID').value, 
                    phone: document.getElementById('uPhone').value,
                    loginTime: new Date().toLocaleString('ar-EG')
                };
                document.getElementById('userName').innerText = name;
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('contentArea').classList.remove('hidden');
                document.getElementById('menuBtn').classList.remove('hidden');
                saveToAdmin('users', currentUser);
            } else { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!"); }
        }

        async function processPDF(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let text = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(s => s.str).join(" ") + " \n ";
                }
                allPDFs.push({ name: file.name, text: text });
                alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ø²Ù†Ø© âœ…");
                renderVault();
            };
            reader.readAsArrayBuffer(file);
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('sidebar').classList.add('translate-x-full');
            if(id === 'studyStats') renderStats();
            if(id === 'examHistory') renderHistory();
        }

        function renderVault() {
            document.getElementById('vaultList').innerHTML = allPDFs.map((p, i) => `
                <div onclick="openPDF(${i})" class="glass p-4 rounded-xl cursor-pointer hover:border-blue-500">
                    ğŸ“„ ${p.name}
                </div>
            `).join('');
        }

        function openPDF(idx) {
            showSection('mainDashboard');
            const pdf = allPDFs[idx];
            const words = pdf.text.split(/\s+/);
            document.getElementById('pdfView').innerHTML = words.map(w => `<span class="word-span" onclick="trans(this)">${w} </span>`).join('');
        }

        async function trans(el) {
            const word = el.innerText.trim();
            if(word.length < 2) return;
            document.querySelectorAll('.translation-popup').forEach(p => p.remove());
            const p = document.createElement('div');
            p.className = 'translation-popup'; p.innerText = "...";
            el.appendChild(p);
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                method: "POST",
                body: JSON.stringify({ contents: [{ parts: [{ text: `Translate: ${word} to Arabic` }] }] })
            });
            const data = await res.json();
            p.innerText = data.candidates[0].content.parts[0].text;
        }

        async function startMode(mode) {
            if(allPDFs.length === 0) return alert("Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹");
            const side = document.getElementById('sideContent');
            const count = mode === 'comprehensive' ? 30 : 10;
            examStartTime = Date.now();
            side.innerHTML = `<div class="loader"></div><p>ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${count} Ø³Ø¤Ø§Ù„ Ù…Ù† Ù…Ù„ÙØ§ØªÙƒ...</p>`;
            
            const txt = mode === 'comprehensive' ? allPDFs.map(p => p.text).join(" ") : allPDFs[allPDFs.length-1].text;
            const prompt = `Based on: "${txt.substring(0, 4000)}", generate ${count} MCQ in Arabic. JSON: [{"q":"..","o":["..","..","..",".."],"a":index}]`;
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: "POST",
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const qs = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, ""));
                
                let cur = 0, score = 0;
                const renderQ = () => {
                    const q = qs[cur];
                    side.innerHTML = `
                        <div class="text-right">
                            <h3 class="font-bold mb-4 text-sm">${q.q}</h3>
                            ${q.o.map((o, i) => `<button onclick="check(${i},${q.a},this)" class="option-btn text-xs">${o}</button>`).join('')}
                            <button id="nxt" disabled onclick="nxtQ()" class="w-full bg-white text-black py-2 rounded-xl opacity-20 font-bold">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>
                        </div>
                    `;
                };
                window.check = (i, a, b) => {
                    const btns = document.querySelectorAll('.option-btn');
                    btns.forEach(x => x.disabled = true);
                    if(i === a) { b.classList.add('correct'); score++; }
                    else { b.classList.add('wrong'); btns[a].classList.add('correct'); }
                    document.getElementById('nxt').disabled = false; document.getElementById('nxt').style.opacity = "1";
                };
                window.nxtQ = () => {
                    cur++;
                    if(cur < count) renderQ();
                    else {
                        const duration = Math.floor((Date.now() - examStartTime)/1000);
                        const examResult = { score: `${score}/${count}`, type: mode === 'comprehensive' ? 'Ø´Ø§Ù…Ù„' : 'Ø¹Ø§Ø¯ÙŠ', time: duration + ' Ø«Ø§Ù†ÙŠØ©', date: new Date().toLocaleString('ar-EG') };
                        saveToUser('exams', examResult);
                        side.innerHTML = `<h2 class="text-4xl font-bold">${score}/${count}</h2><p>ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø³Ø¬Ù„Ùƒ</p>`;
                    }
                };
                renderQ();
            } catch(e) { side.innerHTML = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©."; }
        }

        function saveToUser(key, val) {
            let data = JSON.parse(localStorage.getItem(`user_${currentUser.phone}_${key}`) || "[]");
            data.push(val);
            localStorage.setItem(`user_${currentUser.phone}_${key}`, JSON.stringify(data));
        }

        function saveToAdmin(key, val) {
            let data = JSON.parse(localStorage.getItem(`admin_${key}`) || "[]");
            data.push({ ...val, fromUser: currentUser?.name || 'Ù…Ø¬Ù‡ÙˆÙ„' });
            localStorage.setItem(`admin_${key}`, JSON.stringify(data));
        }

        function renderStats() {
            // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            saveToUser('stats', { date: new Date().toLocaleDateString('ar-EG'), duration: document.getElementById('sessionTimer').innerText });
            const stats = JSON.parse(localStorage.getItem(`user_${currentUser.phone}_stats`) || "[]");
            document.getElementById('statsBody').innerHTML = stats.map(s => `<tr><td class="p-2">${s.date}</td><td class="p-2">${s.duration}</td></tr>`).join('');
        }

        function renderHistory() {
            const exams = JSON.parse(localStorage.getItem(`user_${currentUser.phone}_exams`) || "[]");
            document.getElementById('historyList').innerHTML = exams.map(e => `
                <div class="glass p-4 rounded-xl text-xs flex justify-between items-center">
                    <div><span class="font-bold text-orange-400">${e.score}</span> | Ù†ÙˆØ¹: ${e.type}</div>
                    <div class="text-[10px] text-gray-500">${e.date} (${e.time})</div>
                </div>
            `).join('');
        }

        function showAdminPrompt() {
            if(prompt("Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø§Ø¯Ù…Ù†:") === "1542") {
                showSection('adminPanel');
                const users = JSON.parse(localStorage.getItem('admin_users') || "[]");
                const reports = JSON.parse(localStorage.getItem('admin_reports') || "[]");
                document.getElementById('adminData').innerHTML = `
                    <div class="glass p-4 rounded-xl"><h3>Ø§Ù„Ø·Ù„Ø§Ø¨ (${users.length})</h3><div class="space-y-2 text-[10px] mt-4">${users.map(u => `<p>â€¢ ${u.name} - ${u.phone}</p>`).join('')}</div></div>
                    <div class="glass p-4 rounded-xl"><h3>Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h3><div class="space-y-2 text-[10px] mt-4">${reports.map(r => `<p>â€¢ ${r.fromUser}: ${r.msg} (${r.rate}â˜…)</p>`).join('')}</div></div>
                    <div class="glass p-4 rounded-xl"><h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø§Øª: ${JSON.parse(localStorage.getItem('admin_users') || "[]").length}</p></div>
                `;
            } else alert("Ø®Ø·Ø£!");
        }

        document.getElementById('menuBtn').onclick = () => document.getElementById('sidebar').classList.toggle('translate-x-full');
        function setRate(n) { rating = n; document.querySelectorAll('.star').forEach((s,i) => s.style.color = i < n ? '#f2c94c' : '#30363d'); }
        function sendMsg() { 
            saveToAdmin('reports', { msg: document.getElementById('msg').value, rate: rating }); 
            alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); 
            showSection('mainDashboard'); 
        }
    </script>
</body>
</html>
